# Siscora Platform - PWA Implementation Guide

This document provides detailed information about the Progressive Web App (PWA) implementation in the Siscora Platform, including setup, features, and customization options.

## Table of Contents

- [Features](#features)
- [Implementation Details](#implementation-details)
  - [Service Worker](#service-worker)
  - [Web App Manifest](#web-app-manifest)
  - [Icons and Splash Screens](#icons-and-splash-screens)
  - [Installation Prompt](#installation-prompt)
- [Development](#development)
- [Testing](#testing)
- [Deployment](#deployment)
- [Troubleshooting](#troubleshooting)
- [Customization](#customization)

## Features

- **Offline Support**: The app can work offline or with a poor internet connection using service workers.
- **Installable**: Users can install the app on their device's home screen (both mobile and desktop).
- **Fast Loading**: Assets are cached for faster loading on subsequent visits.
- **Responsive Design**: The app works on all device sizes and orientations.
- **App-like Experience**: Full-screen mode, standalone display, and custom splash screens.
- **Push Notifications**: Ready to be implemented (see [Push Notifications](#push-notifications)).

## Implementation Details

### Service Worker

The service worker (`public/sw.js`) is automatically generated by `next-pwa` and provides the following functionality:

- **Pre-caching**: Core application files are cached during the install event.
- **Runtime Caching**: Dynamic content is cached at runtime.
- **Offline Support**: Serves cached content when offline.
- **Update Management**: Handles updates to the service worker and notifies users.

#### Cache Strategy

| Resource Type | Strategy | Description |
|--------------|----------|-------------|
| Static Assets | Cache First | JS, CSS, images, and fonts are served from cache first, falling back to network. |
| HTML Pages | Network First | Serves fresh content when online, falls back to cache when offline. |
| API Requests | Network Only | Always fetches from the network (not cached by default). |
| Other | Stale While Revalidate | Serves cached content first, then updates the cache in the background. |

### Web App Manifest

The `public/manifest.json` file contains metadata about the application, including:

- App name and short name
- Start URL and scope
- Display mode (standalone, fullscreen, etc.)
- Theme and background colors
- Icons and splash screens
- Related applications

### Icons and Splash Screens

App icons are generated in multiple sizes and stored in the `public/icons` directory. The following sizes are included:

| Size | Purpose |
|------|---------|
| 16x16 | Browser favicon |
| 32x32 | Browser favicon |
| 48x48 | Windows 8.1/10 Desktop |
| 72x72 | First and second generation iPad |
| 96x96 | Google TV |
| 120x120 | iPhone Retina |
| 128x128 | Chrome Web Store |
| 144x144 | IE10 Metro |
| 152x152 | iPad Touch Icon |
| 180x180 | iPhone 6 Plus |
| 192x192 | Android Chrome |
| 384x384 | Android Chrome |
| 512x512 | Android Chrome |

Splash screens are automatically generated based on the icons and manifest settings.

### Installation Prompt

The app includes a custom installation prompt that appears when the app can be installed. The prompt is implemented in `app/pwa-install-prompt.tsx` and includes:

- Custom UI for the installation prompt
- Event listeners for the `beforeinstallprompt` event
- Installation success/failure handling
- User preferences storage to avoid showing the prompt too frequently

## Development

### Prerequisites

- Node.js 18.0.0 or later
- npm or yarn

### Installation

1. Install dependencies:
   ```bash
   npm install
   # or
   yarn install
   ```

2. Generate app icons (required for PWA):
   ```bash
   npm run generate-icons
   # or
   yarn generate-icons
   ```

3. Start the development server:
   ```bash
   npm run dev
   # or
   yarn dev
   ```

### Development Notes

- The service worker is disabled in development mode by default to prevent caching issues.
- To test the service worker in development, set `disable: false` in `next.config.js` under the `pwa` configuration.
- Use Chrome DevTools > Application > Service Workers to test and debug service workers.

## Testing

### Testing the PWA

1. **Development Mode**:
   - Run `npm run dev`
   - Open Chrome DevTools > Application > Service Workers to test the service worker
   - Go to Application > Manifest to test the web app manifest
   - Use the Network tab to test offline behavior

2. **Production Mode**:
   - Build the app: `npm run build`
   - Start the production server: `npm start`
   - Test the PWA features in a production-like environment
   - Use Chrome Lighthouse to audit the PWA and check for any issues

3. **Testing Offline Mode**:
   - In Chrome DevTools, go to the Network tab
   - Check the "Offline" checkbox to simulate being offline
   - Refresh the page to test offline functionality
   - Navigate around the app to ensure all necessary resources are cached

4. **Testing Installation**:
   - On mobile: Look for the "Add to Home Screen" prompt
   - On desktop (Chrome): Look for the install icon in the address bar
   - Test the custom install prompt by triggering the `beforeinstallprompt` event

## Deployment

### Vercel

1. Push your code to a Git repository
2. Import the repository to Vercel
3. Configure the build settings:
   - Build Command: `npm run build`
   - Output Directory: `.next`
   - Install Command: `npm install`
4. Add environment variables if needed
5. Deploy!

### Other Platforms

1. Build the app: `npm run build`
2. Export the static files: `npm run export`
3. Deploy the `out` directory to your hosting provider

### HTTPS Requirement

For PWA features to work, your app must be served over HTTPS in production. Most hosting providers (like Vercel, Netlify, etc.) provide HTTPS by default.

## Troubleshooting

### Service Worker Not Registering
- Ensure the app is served over HTTPS in production
- Check the browser's console for any errors
- Clear site data and hard refresh
- Check if the service worker is properly built in the `.next` directory

### Manifest Issues
- Verify the `manifest.json` file is correctly formatted
- Check the "Application" tab in Chrome DevTools for manifest errors
- Ensure all icon paths in the manifest are correct

### Installation Issues
- The app must be served over HTTPS (except for localhost)
- The web app manifest must be valid
- The service worker must be registered
- The app must be visited at least twice (first visit registers the service worker)

## Customization

### Changing App Name and Colors

1. Update `public/manifest.json`:
   - `name`: Full app name
   - `short_name`: Short app name (for home screen)
   - `theme_color`: App theme color
   - `background_color`: Splash screen background color

2. Update `app/layout.tsx`:
   - Update the theme color meta tag
   - Update any other PWA-related meta tags

### Adding Custom Icons

1. Replace the `public/icons/icon.svg` file with your custom icon
2. Run `npm run generate-icons` to generate all required icon sizes
3. The icons will be saved to the `public/icons` directory

### Customizing the Install Prompt

To customize the install prompt, modify the `app/pwa-install-prompt.tsx` file. You can:
- Change the design to match your app's theme
- Add additional buttons or information
- Modify when and how the prompt appears

### Adding Push Notifications

To implement push notifications:

1. Request notification permission from the user
2. Set up a push service worker
3. Handle incoming push events
4. Display notifications to the user

Example implementation:

```typescript
// Request notification permission
const requestNotificationPermission = async () => {
  const permission = await Notification.requestPermission();
  if (permission === 'granted') {
    // Get the service worker registration
    const registration = await navigator.serviceWorker.ready;
    // Subscribe to push notifications
    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: 'YOUR_VAPID_PUBLIC_KEY'
    });
    // Send the subscription to your server
    await fetch('/api/subscribe', {
      method: 'POST',
      body: JSON.stringify(subscription),
      headers: {
        'Content-Type': 'application/json',
      },
    });
  }
};
```

## Updating the PWA

When you make changes to your PWA:

1. Update the `version` in `package.json`
2. The service worker will automatically detect the new version and update in the background
3. Users will be prompted to refresh the page to get the latest version

## Resources

- [Next.js PWA Documentation](https://github.com/shadowwalker/next-pwa)
- [Web App Manifest Reference](https://developer.mozilla.org/en-US/docs/Web/Manifest)
- [Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
- [PWA Checklist](https://web.dev/pwa-checklist/)

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.
